<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RemoteStorage Notes App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    textarea { width: 100%; height: 80px; }
    .note { background: #f5f5f5; margin: 1em 0; padding: 1em; border-radius: 5px; }
    .note-date { font-size: 0.9em; color: #888; }
    button { margin: 0.3em; }
    #noteForm { margin-top: 1em; }
    #remotestorage-widget-anchor { margin-bottom: 1em; }
  </style>
  <!-- RemoteStorage core library (jsDelivr CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/remotestoragejs@2.0.0-beta.7/release/remotestorage.min.js"></script>
  <!-- RemoteStorage Connect Widget (jsDelivr CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/remotestorage-widget@1.6.0/build/widget.min.js"></script>
</head>
<body>
  <h1>Notes App (RemoteStorage)</h1>
  <div id="remotestorage-widget-anchor"></div>
  <form id="noteForm" style="display:none;">
    <textarea id="noteInput" placeholder="Enter your note..."></textarea>
    <button type="submit">Save Note</button>
    <button type="button" id="cancelEdit" style="display:none;">Cancel Edit</button>
  </form>
  <div id="notesList"></div>

  <script>
    // Initialize RemoteStorage and the notes module
    const remoteStorage = new RemoteStorage();

    remoteStorage.defineModule('notes', function(privateClient) {
      return {
        exports: {
          saveNote: function(note) {
            return privateClient.storeObject('note', note.id, note);
          },
          removeNote: function(id) {
            return privateClient.remove('notes/' + id);
          },
          listNotes: function() {
            return privateClient.getAll('notes/');
          }
        }
      };
    });

    remoteStorage.access.claim('notes', 'rw');
    remoteStorage.caching.enable('/notes/');

    // Attach the Connect Widget
    remoteStorage.displayWidget('remotestorage-widget-anchor');

    // UI elements
    const noteForm = document.getElementById('noteForm');
    const noteInput = document.getElementById('noteInput');
    const notesList = document.getElementById('notesList');
    const cancelEditBtn = document.getElementById('cancelEdit');

    let notes = {};
    let editingId = null;

    // Load and display notes
    async function loadNotes() {
      notes = await remoteStorage.notes.listNotes();
      displayNotes();
    }

    function displayNotes() {
      notesList.innerHTML = '';
      // Sort notes by most recent
      Object.values(notes)
        .sort((a, b) => b.id - a.id)
        .forEach(note => {
          const div = document.createElement('div');
          div.className = 'note';
          div.innerHTML = `
            <div>${linkify(note.content)}</div>
            <div class="note-date">${note.date}</div>
            <button onclick="editNote('${note.id}')">Edit</button>
            <button onclick="deleteNote('${note.id}')">Delete</button>
          `;
          notesList.appendChild(div);
        });
    }

    // Make URLs clickable
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url =>
        `<a href="${url}" target="_blank" rel="noopener">${url}</a>`
      );
    }

    // Form submit: create or update note
    noteForm.onsubmit = async function(e) {
      e.preventDefault();
      const content = noteInput.value.trim();
      if (!content) return;
      let note;
      if (editingId) {
        note = notes[editingId];
        note.content = content;
        note.date = new Date().toLocaleString();
      } else {
        note = {
          id: Date.now().toString(),
          content: content,
          date: new Date().toLocaleString()
        };
      }
      await remoteStorage.notes.saveNote(note);
      noteInput.value = '';
      editingId = null;
      cancelEditBtn.style.display = 'none';
      await loadNotes();
    };

    // Cancel editing
    cancelEditBtn.onclick = function() {
      noteInput.value = '';
      editingId = null;
      cancelEditBtn.style.display = 'none';
    };

    // Expose edit/delete to global scope for button onclick
    window.editNote = function(id) {
      noteInput.value = notes[id].content;
      editingId = id;
      cancelEditBtn.style.display = '';
      noteInput.focus();
    };

    window.deleteNote = async function(id) {
      if (editingId === id) {
        noteInput.value = '';
        editingId = null;
        cancelEditBtn.style.display = 'none';
      }
      await remoteStorage.notes.removeNote(id);
      await loadNotes();
    };

    // Show/hide UI based on connection state
    remoteStorage.on('connected', function() {
      noteForm.style.display = '';
      loadNotes();
    });

    remoteStorage.on('disconnected', function() {
      noteForm.style.display = 'none';
      notesList.innerHTML = '';
      notes = {};
      editingId = null;
      cancelEditBtn.style.display = 'none';
    });

    // If already connected, show UI
    if (remoteStorage.connected) {
      noteForm.style.display = '';
      loadNotes();
    }
  </script>
</body>
</html>
