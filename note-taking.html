<!DOCTYPE html>
<html>
<head>
  <title>RemoteStorage Notes App</title>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    textarea { width: 100%; height: 80px; }
    .note { background: #f5f5f5; margin: 1em 0; padding: 1em; border-radius: 5px; }
    .note-date { font-size: 0.9em; color: #888; }
    button { margin: 0.3em; }
  </style>
  <script src="https://unpkg.com/remotestoragejs@latest/release/remotestorage.min.js"></script>
</head>
<body>
  <h1>Notes App (RemoteStorage)</h1>
  <button id="connect-btn">Connect RemoteStorage</button>
  <button id="disconnect-btn" style="display:none;">Disconnect</button>
  <form id="noteForm" style="display:none;">
    <textarea id="noteInput" placeholder="Enter your note..."></textarea>
    <button type="submit">Save Note</button>
  </form>
  <div id="notesList"></div>

  <script>
    // Register a "notes" module with RemoteStorage
    remoteStorage.defineModule('notes', function(privateClient) {
      return {
        exports: {
          // Save or update a note (by id)
          saveNote: function(note) {
            return privateClient.storeObject('note', note.id, note);
          },
          // Remove a note (by id)
          removeNote: function(id) {
            return privateClient.remove('notes/' + id);
          },
          // List all notes
          listNotes: function() {
            return privateClient.getAll('notes/');
          }
        }
      };
    });

    // Enable access to the "notes" module
    remoteStorage.access.claim('notes', 'rw');
    remoteStorage.caching.enable('/notes/');

    // UI elements
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const noteForm = document.getElementById('noteForm');
    const noteInput = document.getElementById('noteInput');
    const notesList = document.getElementById('notesList');

    let notes = {};

    // Connect/Disconnect handlers
    connectBtn.onclick = () => remoteStorage.connect();
    disconnectBtn.onclick = () => remoteStorage.disconnect();

    // Listen for connection changes
    remoteStorage.on('connected', async function() {
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = '';
      noteForm.style.display = '';
      await loadNotes();
    });

    remoteStorage.on('disconnected', function() {
      connectBtn.style.display = '';
      disconnectBtn.style.display = 'none';
      noteForm.style.display = 'none';
      notesList.innerHTML = '';
      notes = {};
    });

    // Load notes from RemoteStorage
    async function loadNotes() {
      notes = await remoteStorage.notes.listNotes();
      displayNotes();
    }

    // Display notes
    function displayNotes() {
      notesList.innerHTML = '';
      Object.values(notes).sort((a, b) => b.id - a.id).forEach(note => {
        const div = document.createElement('div');
        div.className = 'note';
        div.innerHTML = `
          <div>${linkify(note.content)}</div>
          <div class="note-date">${note.date}</div>
          <button onclick="editNote('${note.id}')">Edit</button>
          <button onclick="deleteNote('${note.id}')">Delete</button>
        `;
        notesList.appendChild(div);
      });
    }

    // Linkify URLs
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => 
        `<a href="${url}" target="_blank" rel="noopener">${url}</a>`
      );
    }

    // CRUD Handlers
    noteForm.onsubmit = async function(e) {
      e.preventDefault();
      const content = noteInput.value.trim();
      if (!content) return;
      let editingId = noteForm.dataset.editing;
      let note;
      if (editingId) {
        note = notes[editingId];
        note.content = content;
        note.date = new Date().toLocaleString();
        delete noteForm.dataset.editing;
      } else {
        note = {
          id: Date.now().toString(),
          content: content,
          date: new Date().toLocaleString()
        };
      }
      await remoteStorage.notes.saveNote(note);
      noteInput.value = '';
      await loadNotes();
    };

    window.deleteNote = async function(id) {
      await remoteStorage.notes.removeNote(id);
      await loadNotes();
    };

    window.editNote = function(id) {
      noteInput.value = notes[id].content;
      noteForm.dataset.editing = id;
      noteInput.focus();
    };

    // Show connect button on load if not connected
    if (!remoteStorage.connected) {
      connectBtn.style.display = '';
    } else {
      disconnectBtn.style.display = '';
      noteForm.style.display = '';
      loadNotes();
    }
  </script>
</body>
</html>
